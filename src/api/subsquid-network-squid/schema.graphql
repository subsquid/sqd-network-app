### COMMON ###

scalar BigInt

# Network status and configuration queries
query squidNetworkHeight {
  squidStatus {
    height
  }
}

query settings {
  settingsConnection(orderBy: id_ASC) {
    edges {
      node {
        id
        bondAmount
        delegationLimitCoefficient
        minimalWorkerVersion
        recommendedWorkerVersion
      }
    }
  }
}

### FRAGMENTS ###

# Base fragments
fragment AccountFragment on Account {
  id
  type
  balance
}

fragment OwnerFragment on Account {
  id
  type
}

fragment VestingFragment on Account {
  id
  type
  balance
  owner {
    id
  }
}

fragment DelegationFragment on Delegation {
  deposit
  claimableReward
  claimedReward
  locked
  lockEnd
  owner {
    id
    type
    owner {
      id
    }
  }
}

fragment GatewayStakeBaseFragment on GatewayStake {
  id
  amount
}

### ACCOUNT QUERIES ###

# Get basic account information
query sources($address: String!) {
  accounts(
    where: { OR: [{ id_eq: $address }, { owner: { id_eq: $address } }] }
    orderBy: [type_ASC, id_ASC]
  ) {
    ...AccountFragment
  }
}

query vestingsByAccount($address: String!) {
  accounts(where: { owner: { id_eq: $address }, type_eq: VESTING }) {
    ...AccountFragment
  }
}

query temporaryHoldingsByAccount($address: String!) {
  accounts(
    where: {
      OR: [
        { temporaryHolding: { beneficiary: { id_eq: $address } } }
        { owner: { id_eq: $address }, type_eq: TEMPORARY_HOLDING }
      ]
    }
  ) {
    ...AccountFragment
    temporaryHolding {
      locked
    }
  }
}

# Get accounts with all associated assets
query sourcesWithAssets($address: String!) {
  accounts(
    where: { OR: [{ id_eq: $address }, { owner: { id_eq: $address } }] }
    orderBy: [type_ASC, id_ASC]
  ) {
    ...AccountFragment

    workers2(where: { OR: [{ bond_gt: 0 }, { claimableReward_gt: 0 }] }) {
      ...WorkerBaseFragment
      bond
      claimableReward
    }

    delegations2(where: { OR: [{ deposit_gt: 0 }, { claimableReward_gt: 0 }] }) {
      ...DelegationFragment
      worker {
        ...WorkerBaseFragment
      }
    }

    gatewayStakes(where: { amount_gt: 0 }) {
      ...GatewayStakeBaseFragment
    }
  }
}

# Get accounts with delegations for specific worker
query sourcesWithDelegations($address: String!, $peerId: String) {
  accounts(
    where: { OR: [{ id_eq: $address }, { owner: { id_eq: $address } }] }
    orderBy: [type_ASC, id_ASC]
  ) {
    ...AccountFragment

    delegations2(where: { OR: [{ deposit_gt: 0 }], AND: [{ worker: { peerId_eq: $peerId } }] }) {
      ...DelegationFragment
      worker {
        ...WorkerBaseFragment
      }
    }
  }
}

# Get user's vesting account
query vestingByAddress($address: String!) {
  accountById(id: $address) {
    ...VestingFragment
  }
}

### WORKER FRAGMENTS ###

fragment WorkerBaseFragment on Worker {
  id
  name
  peerId
}

fragment WorkerStatusFragment on Worker {
  status
  online
  jailed
  dialOk
  jailReason
  statusHistory(orderBy: id_DESC, limit: 1) {
    blockNumber
    pending
    timestamp
  }
}

fragment WorkerStatsFragment on Worker {
  version
  createdAt
  uptime90Days
  uptime24Hours
  apr
  stakerApr
  totalDelegation
  capedDelegation
  delegationCount
  locked
  lockEnd
}

fragment WorkerMetricsFragment on Worker {
  queries24Hours
  queries90Days
  scannedData24Hours
  scannedData90Days
  servedData24Hours
  servedData90Days
  storedData
}

fragment WorkerRewardsFragment on Worker {
  bond
  claimableReward
  claimedReward
  totalDelegationRewards
}

fragment WorkerProfileFragment on Worker {
  website
  email
  description
}

fragment WorkerOwnershipFragment on Worker {
  owner {
    ...OwnerFragment
    owner {
      id
    }
  }
}

fragment WorkerFragment on Worker {
  ...WorkerBaseFragment
  ...WorkerStatusFragment
  ...WorkerStatsFragment
  ...WorkerOwnershipFragment
}

fragment WorkerDetailedFragment on Worker {
  ...WorkerFragment
  ...WorkerRewardsFragment
  ...WorkerMetricsFragment
  ...WorkerProfileFragment
  dayUptimes {
    timestamp
    uptime
  }
}

### WORKER QUERIES ###

# Get all active workers
query allWorkers {
  workers(where: { status_eq: ACTIVE }, orderBy: totalDelegation_ASC) {
    ...WorkerFragment
  }
}

# Get detailed worker information by peer ID
query workerByPeerId($peerId: String!, $address: String) {
  workers(where: { peerId_eq: $peerId }, limit: 1) {
    ...WorkerDetailedFragment
    delegations(
      where: {
        OR: [
          { owner: { id_eq: $address }, deposit_gt: 0 }
          { owner: { owner: { id_eq: $address } }, deposit_gt: 0 }
        ]
      }
    ) {
      ...DelegationFragment
    }
  }
}

# Get worker uptime history
query workerDaysUptimeById($id: String!, $from: DateTime!) {
  workerSnapshotsByDay(workerId: $id, from: $from) {
    timestamp
    uptime
  }
}

# Get user's owned workers
query myWorkers($address: String!) {
  workers(
    orderBy: id_ASC
    where: {
      OR: [
        { owner: { id_eq: $address }, status_not_eq: WITHDRAWN }
        { owner: { owner: { id_eq: $address } }, status_not_eq: WITHDRAWN }
        {
          owner: { temporaryHolding: { beneficiary: { id_eq: $address } } }
          status_not_eq: WITHDRAWN
        }
      ]
    }
  ) {
    ...WorkerFragment
    ...WorkerRewardsFragment
  }
}

# Get count of user's workers
query myWorkersCount($address: String!) {
  workersConnection(
    orderBy: id_ASC
    where: { OR: [{ owner: { id_eq: $address } }, { owner: { owner: { id_eq: $address } } }] }
  ) {
    totalCount
  }
}

# Get worker delegation information for staking calculations
query workerDelegationInfo($workerId: String!) {
  workerById(id: $workerId) {
    bond
    totalDelegation
    capedDelegation
    liveness
    dTenure
    trafficWeight
  }

  settings(limit: 1) {
    utilizedStake
    baseApr
  }
}

# Get worker ownership information
query workerOwner($workerId: String!) {
  workerById(id: $workerId) {
    ...WorkerOwnershipFragment
  }
}

# Get user's delegations to workers
query myDelegations($address: String!, $workerId: String) {
  workers(
    orderBy: id_ASC
    where: {
      peerId_eq: $workerId
      delegations_some: {
        OR: [
          { owner: { id_eq: $address }, deposit_gt: 0 }
          { owner: { owner: { id_eq: $address } }, deposit_gt: 0 }
          { owner: { temporaryHolding: { beneficiary: { id_eq: $address } } }, deposit_gt: 0 }
        ]
      }
    }
  ) {
    ...WorkerFragment
    delegations(
      where: {
        OR: [
          { owner: { id_eq: $address }, deposit_gt: 0 }
          { owner: { owner: { id_eq: $address } }, deposit_gt: 0 }
          { owner: { temporaryHolding: { beneficiary: { id_eq: $address } } }, deposit_gt: 0 }
        ]
      }
    ) {
      ...DelegationFragment
    }
  }
}

# Get user's claimable rewards
query myClaims($address: String!) {
  delegations(
    where: {
      OR: [
        { owner: { id_eq: $address }, claimableReward_gt: 0 }
        { owner: { owner: { id_eq: $address } }, claimableReward_gt: 0 }
      ]
    }
  ) {
    claimableReward
    deposit
    worker {
      ...WorkerBaseFragment
    }
    owner {
      ...OwnerFragment
    }
  }

  workers(
    where: {
      OR: [
        { owner: { id_eq: $address }, claimableReward_gt: 0 }
        { owner: { owner: { id_eq: $address } }, claimableReward_gt: 0 }
      ]
    }
  ) {
    ...WorkerBaseFragment
    claimableReward
    owner {
      ...OwnerFragment
    }
  }
}

### GATEWAY FRAGMENTS ###

fragment GatewayFragment on Gateway {
  id
  name
  status
  description
  email
  endpointUrl
  website
  createdAt
  owner {
    ...OwnerFragment
  }
}

fragment GatewayStakeFragment on GatewayStake {
  ...GatewayStakeBaseFragment
  owner {
    ...OwnerFragment
  }
  autoExtension
  computationUnits
  computationUnitsPending
  locked
  lockStart
  lockEnd
}

### GATEWAY QUERIES ###

# Get gateway by peer ID
query gatewayByPeerId($peerId: String!) {
  gatewayById(id: $peerId) {
    ...GatewayFragment
  }
}

# Get user's gateways
query myGateways($address: String!) {
  gateways(where: { owner: { id_eq: $address }, status_not_eq: DEREGISTERED }) {
    ...GatewayFragment
  }
}

# Get user's gateway stakes with network info
query myGatewayStakes($address: String!) {
  gatewayStakes(
    where: {
      OR: [
        { owner: { id_eq: $address }, amount_gt: "0" }
        { owner: { owner: { id_eq: $address } }, amount_gt: "0" }
      ]
    }
  ) {
    ...GatewayStakeFragment
  }

  networkStats {
    blockTimeL1
    lastBlockL1
    lastBlockTimestampL1
  }
}

### NETWORK QUERIES ###

query networkSummary {
  networkStats {
    onlineWorkersCount
    queries90Days
    queries24Hours
    servedData90Days
    servedData24Hours
    stakerApr
    totalBond
    totalDelegation
    totalPortalLock
    storedData
    workerApr
    workersCount
    aprs {
      stakerApr
      timestamp
      workerApr
    }
  }
}

query currentEpoch {
  networkStats {
    blockTimeL1
    lastBlockL1
    lastBlockTimestampL1
  }

  epoches(limit: 1, orderBy: id_DESC) {
    number
    start
    end
  }
}

### TIMESERIES QUERIES ###

query HoldersCountTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  holdersCountTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query LockedValueTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  lockedValueTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query ActiveWorkersTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  activeWorkersTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query UniqueOperatorsTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  uniqueOperatorsTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query DelegationsTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  delegationsTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query DelegatorsTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  delegatorsTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query TransfersByTypeTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  transfersByTypeTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value {
        deposit
        withdraw
        transfer
        reward
        release
      }
    }
    step
  }
}

query UniqueAccountsTimeseries($from: DateTime!, $to: DateTime!, $step: String) {
  uniqueAccountsTimeseries(from: $from, to: $to, step: $step) {
    data {
      timestamp
      value
    }
    step
  }
}

query QueriesCountTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  queriesCountTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value
    }
    step
  }
}

query ServedDataTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  servedDataTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value
    }
    step
  }
}

query StoredDataTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  storedDataTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value
    }
    step
  }
}

query RewardTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  rewardTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value {
        workerReward
        stakerReward
      }
    }
    step
  }
}

query AprTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  aprTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value {
        workerApr
        stakerApr
      }
    }
    step
  }
}

query UptimeTimeseries($from: DateTime!, $to: DateTime!, $step: String, $workerId: String) {
  uptimeTimeseries(from: $from, to: $to, step: $step, workerId: $workerId) {
    data {
      timestamp
      value
    }
    step
  }
}

